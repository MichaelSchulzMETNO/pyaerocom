

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Notebooks &mdash; pyaerocom  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="pyaerocom  documentation" href="index.html"/>
        <link rel="next" title="API" href="api.html"/>
        <link rel="prev" title="Introduction" href="readme.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> pyaerocom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html#documentation">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html#requirements">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="readme.html#installation">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Notebooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introducing-the-modeldata-class">Introducing the <code class="docutils literal"><span class="pre">ModelData</span></code> class</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#note">Note</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#to-be-continued">To be continued ..</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#handling-of-cf-time-in-pyaerocom">Handling of CF time in <em>Pyaerocom</em></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#load-and-plot-some-example-data">Load and plot some example data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#digging-into-the-time-representation-of-iris-cubes">Digging into the time representation of iris Cubes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#peculiarities-of-time-handling-when-using-the-cube-interface">Peculiarities of time handling when using the <code class="docutils literal"><span class="pre">Cube</span></code> interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other-options-to-convert-timestamps">Other options to convert timestamps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_testsuite.html">API test-suite</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_files.html">Configuration files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pyaerocom</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Notebooks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/notebooks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="notebooks">
<h1>Notebooks<a class="headerlink" href="#notebooks" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introducing-the-modeldata-class">
<h2>Introducing the <code class="docutils literal"><span class="pre">ModelData</span></code> class<a class="headerlink" href="#introducing-the-modeldata-class" title="Permalink to this headline">¶</a></h2>
<p>This notebook introduces basic features of the
<a class="reference external" href="http://aerocom.met.no/pyaerocom/api.html#pyaerocom.modeldata.ModelData">ModelData</a>
class of pyaerocom. The <code class="docutils literal"><span class="pre">ModelData</span></code> class is the fundamental base
class for the analysis of model data. The underlying data type is
<a class="reference external" href="http://scitools.org.uk/iris/docs/latest/iris/iris/cube.html#iris.cube.Cube">iris.cube.Cube</a>
which was extended, for instance by allowing direct imports of netCDF
files when creating an instance of <code class="docutils literal"><span class="pre">ModelData</span></code> (i.e. by passing the
filename and specifying the variable name on initialisation). This
notebook introduces some of the features of the <code class="docutils literal"><span class="pre">ModelData</span></code> class.
Starting with some imports…</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyaerocom</span> <span class="k">import</span> <span class="n">ModelData</span>
</pre></div>
</div>
<p>Let’s get a test file to load</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyaerocom.test_files</span> <span class="k">import</span> <span class="n">get</span>

<span class="n">test_files</span> <span class="o">=</span> <span class="n">get</span><span class="p">()</span>
<span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">test_files</span><span class="p">[</span><span class="s2">&quot;models&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">filepath</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">aatsr_su_v4</span><span class="o">.</span><span class="mi">3</span>
<span class="o">/</span><span class="n">lustre</span><span class="o">/</span><span class="n">storeA</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">aerocom</span><span class="o">/</span><span class="n">aerocom</span><span class="o">-</span><span class="n">users</span><span class="o">-</span><span class="n">database</span><span class="o">/</span><span class="n">CCI</span><span class="o">-</span><span class="n">Aerosol</span><span class="o">/</span><span class="n">CCI_AEROSOL_Phase2</span><span class="o">/</span><span class="n">AATSR_SU_v4</span><span class="o">.</span><span class="mi">3</span><span class="o">/</span><span class="n">renamed</span><span class="o">/</span><span class="n">aerocom</span><span class="o">.</span><span class="n">AATSR_SU_v4</span><span class="o">.</span><span class="mf">3.</span><span class="n">daily</span><span class="o">.</span><span class="n">od550aer</span><span class="o">.</span><span class="mf">2008.</span><span class="n">nc</span>

<span class="n">ecmwf_osuite</span>
<span class="o">/</span><span class="n">lustre</span><span class="o">/</span><span class="n">storeA</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">aerocom</span><span class="o">/</span><span class="n">aerocom1</span><span class="o">/</span><span class="n">ECMWF_OSUITE_NRT_test</span><span class="o">/</span><span class="n">renamed</span><span class="o">/</span><span class="n">aerocom</span><span class="o">.</span><span class="n">ECMWF_OSUITE_NRT_test</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">od550aer</span><span class="o">.</span><span class="mf">2018.</span><span class="n">nc</span>
</pre></div>
</div>
<p>The dictionary, returned by the <code class="docutils literal"><span class="pre">get()</span></code> function is categorised into
two subirectories for model based test files (<code class="docutils literal"><span class="pre">key=&quot;models&quot;</span></code>) and for
observation based test files (<code class="docutils literal"><span class="pre">key=observations</span></code>). So far, there is
not much in there (i.e. only two files).</p>
<p>Let’s pick out the ECMWF OSUITE test file and load the data directly
into an instance of the <code class="docutils literal"><span class="pre">ModelData</span></code> class. The <code class="docutils literal"><span class="pre">ModelData</span></code> class
takes either preloaded instances of the <code class="docutils literal"><span class="pre">iris.cube.Cube</span></code> class as
input, or a valid netCDF file path. The latter requires specification of
the variable name which is then filtered from the data stored in the
netCDF file (which may contain multiple variables. The following example
imports the data for the aerosol optical density at 550 nm. The string
representation of the <code class="docutils literal"><span class="pre">ModelData</span></code> class (see print at end of following
code cell) was slitghtly adapted from the underlying <code class="docutils literal"><span class="pre">Cube</span></code> object.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">fpath</span> <span class="o">=</span> <span class="n">test_files</span><span class="p">[</span><span class="s2">&quot;models&quot;</span><span class="p">][</span><span class="s2">&quot;ecmwf_osuite&quot;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;od550aer&quot;</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;ECMWF_OSUITE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Rolling</span> <span class="n">longitudes</span> <span class="n">to</span> <span class="o">-</span><span class="mi">180</span> <span class="o">-&gt;</span> <span class="mi">180</span> <span class="n">definition</span>
<span class="n">pyaerocom</span><span class="o">.</span><span class="n">ModelData</span><span class="p">:</span> <span class="n">ECMWF_OSUITE</span>
<span class="n">Grid</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dust</span> <span class="n">Aerosol</span> <span class="n">Optical</span> <span class="n">Depth</span> <span class="n">at</span> <span class="mi">550</span><span class="n">nm</span> <span class="o">/</span> <span class="p">(</span><span class="n">unknown</span><span class="p">)</span> <span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">365</span><span class="p">;</span> <span class="n">latitude</span><span class="p">:</span> <span class="mi">451</span><span class="p">;</span> <span class="n">longitude</span><span class="p">:</span> <span class="mi">900</span><span class="p">)</span>
     <span class="n">Dimension</span> <span class="n">coordinates</span><span class="p">:</span>
          <span class="n">time</span>                                       <span class="n">x</span>              <span class="o">-</span>               <span class="o">-</span>
          <span class="n">latitude</span>                                   <span class="o">-</span>              <span class="n">x</span>               <span class="o">-</span>
          <span class="n">longitude</span>                                  <span class="o">-</span>              <span class="o">-</span>               <span class="n">x</span>
     <span class="n">Attributes</span><span class="p">:</span>
          <span class="n">Conventions</span><span class="p">:</span> <span class="n">CF</span><span class="o">-</span><span class="mf">1.0</span>
          <span class="n">NCO</span><span class="p">:</span> <span class="mf">4.7</span><span class="o">.</span><span class="mi">2</span>
          <span class="n">history</span><span class="p">:</span> <span class="n">Tue</span> <span class="n">Mar</span> <span class="mi">20</span> <span class="mi">13</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">49</span> <span class="mi">2018</span><span class="p">:</span> <span class="n">ncks</span> <span class="o">-</span><span class="mi">7</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span><span class="n">o</span> <span class="n">test</span><span class="o">.</span><span class="n">nc</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">v</span> <span class="n">time_bnds</span> <span class="n">od550aer</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">orig</span><span class="o">.</span><span class="n">nc</span>
<span class="n">Tue</span><span class="o">...</span>
          <span class="n">history_of_appended_files</span><span class="p">:</span> <span class="n">Tue</span> <span class="n">Mar</span> <span class="mi">20</span> <span class="mi">02</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">15</span> <span class="mi">2018</span><span class="p">:</span> <span class="n">Appended</span> <span class="n">file</span> <span class="o">/</span><span class="n">lustre</span><span class="o">/</span><span class="n">storeA</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">aerocom</span><span class="o">/</span><span class="n">aerocom1</span><span class="o">/</span><span class="n">ECMWF_OSUITE_NRT</span><span class="o">/</span><span class="n">renamed</span><span class="o">//</span><span class="n">aerocom</span><span class="o">.</span><span class="n">ECMWF_OSUITE_NRT</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">od550bc</span><span class="o">.</span><span class="mf">2018.</span><span class="n">nc</span><span class="o">...</span>
          <span class="n">invalid_units</span><span class="p">:</span> <span class="o">~</span>
          <span class="n">nco_openmp_thread_number</span><span class="p">:</span> <span class="mi">1</span>
     <span class="n">Cell</span> <span class="n">methods</span><span class="p">:</span>
          <span class="n">mean</span><span class="p">:</span> <span class="n">time</span>
</pre></div>
</div>
<div class="section" id="note">
<h3>Note<a class="headerlink" href="#note" title="Permalink to this headline">¶</a></h3>
<div class="alert alert-block alert-info"><p>The longitudes in the ECMWF OSUITE data files are defined</p>
<div class="math">
\[0 \leq\,\text{lon}\,\leq360\]</div>
<p>and are converted automatically to</p>
<div class="math">
\[-180\leq\,\text{lon}\,\leq180\]</div>
<p>when an instance of the <code class="docutils literal"><span class="pre">ModelData</span></code> class is created (see print
statment above <em>Rolling longitudes to -180 -&gt; 180 definition</em>)</p>
</div><p>In the following cell, some of the most important attributes are
introduced. These are mostly reimplementations of the underlying
<code class="docutils literal"><span class="pre">Cube</span></code> data which is stored in the <code class="docutils literal"><span class="pre">ModelData.grid</span></code> attribute. For
instance the attribute <code class="docutils literal"><span class="pre">ModelData.longitude</span></code> get’s you
<code class="docutils literal"><span class="pre">ModelData.grid.coord(&quot;longitude&quot;)</span></code>, <code class="docutils literal"><span class="pre">ModelData.latitude</span></code> get’s you
<code class="docutils literal"><span class="pre">ModelData.grid.coord(&quot;latitude&quot;)</span></code> and <code class="docutils literal"><span class="pre">ModelData.time</span></code> get’s you
<code class="docutils literal"><span class="pre">ModelData.grid.coord(&quot;time&quot;)</span></code>.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">var_name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Longitude attr is pointer to DimCoord instance of underlying Cube: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span> <span class="ow">is</span> <span class="n">data</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">tstamps</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time_stamps</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tstamps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tstamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>od550aer
&lt;class &#39;iris.coords.DimCoord&#39;&gt;
Longitude attr is pointer to DimCoord instance of underlying Cube: True
-180.0 179.60000610351562
-90.0 90.0
0.0 364.0
2018-01-01T00:00:00.000000 2018-12-31T00:00:00.000000
</pre></div>
</div>
<p>If you do not specify the variable type, an Exception is raised, that
will get you some information about what variables are available in the
file (if the file is readable using the <code class="docutils literal"><span class="pre">iris.load</span></code> method).</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">fpath</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This did not work...error message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">work</span><span class="o">...</span><span class="n">error</span> <span class="n">message</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Loading data from input file /lustre/storeA/project/aerocom/aerocom1/ECMWF_OSUITE_NRT_test/renamed/aerocom.ECMWF_OSUITE_NRT_test.daily.od550aer.2018.nc requires specification of a variable name using input parameter var_name. The following variable names exist in input file: [&#39;od550so4&#39;, &#39;od550aer&#39;, &#39;od550bc&#39;, &#39;od550oa&#39;, &#39;od550dust&#39;]&quot;</span><span class="p">,)</span>
<span class="mf">6.357274804629144</span> <span class="mf">0.0009405642475446783</span>
</pre></div>
</div>
<p>Also, if you parse an invalid variable name, you will get some hint.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Blaaa&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This also did not work...error message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">also</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">work</span><span class="o">...</span><span class="n">error</span> <span class="n">message</span><span class="p">:</span> <span class="n">ConstraintMismatchError</span><span class="p">(</span><span class="s1">&#39;no cubes found&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<p>You can have a quick look at the data using the class-own quickplot
method</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">(</span><span class="n">time_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">fix_aspect</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">c_over</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/output_14_0.png" src="_images/output_14_0.png" />
<p>Why not load some of the other variables…</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">data_bc</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;od550bc&quot;</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;ECMWF_OSUITE&quot;</span><span class="p">)</span>
<span class="n">data_so4</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;od550so4&quot;</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;ECMWF_OSUITE&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Rolling</span> <span class="n">longitudes</span> <span class="n">to</span> <span class="o">-</span><span class="mi">180</span> <span class="o">-&gt;</span> <span class="mi">180</span> <span class="n">definition</span>
<span class="n">Rolling</span> <span class="n">longitudes</span> <span class="n">to</span> <span class="o">-</span><span class="mi">180</span> <span class="o">-&gt;</span> <span class="mi">180</span> <span class="n">definition</span>
</pre></div>
</div>
<p>… and plot them as well</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">fig1</span> <span class="o">=</span> <span class="n">data_bc</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">()</span>
<span class="n">fig2</span> <span class="o">=</span> <span class="n">data_so4</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">lon_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                     <span class="n">lat_range</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">(</span><span class="n">fix_aspect</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                                                       <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                                                       <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>
</pre></div>
</div>
<img alt="_images/output_18_0.png" src="_images/output_18_0.png" />
<img alt="_images/output_18_1.png" src="_images/output_18_1.png" />
<div class="section" id="to-be-continued">
<h4>To be continued ..<a class="headerlink" href="#to-be-continued" title="Permalink to this headline">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="handling-of-cf-time-in-pyaerocom">
<h2>Handling of CF time in <em>Pyaerocom</em><a class="headerlink" href="#handling-of-cf-time-in-pyaerocom" title="Permalink to this headline">¶</a></h2>
<p>The
<a class="reference external" href="http://aerocom.met.no/pyaerocom/api.html#module-pyaerocom.modeldata">ModelData</a>
class of <em>Pyaerocom</em> was introduced in <a class="reference external" href="http://aerocom.met.no/pyaerocom/notebooks.html#introducing-the-modeldata-class">this
notebook</a>.</p>
<p>Here, we want to illustrate one particular feature of <em>Pyaerocom</em>,
namely the conversion of CF conform numerical time stamps with a defined
unit (i.e. basedate and calendar, see e.g.
<a class="reference external" href="http://cfconventions.org/Data/cf-conventions/cf-conventions-1.6/build/cf-conventions.html#time-coordinate">here</a>
for details) into datetime-like objects that can be interpreted by tools
such as <a class="reference external" href="https://pandas.pydata.org/">Pandas</a>. The easiest way to work
with time stamps in model data is, to simply work on the internal
numerical indices, avoiding the necessity to convert them into actual
datetime objects. However, sometimes (e.g. if we want to extract and
analyse a time-series of global average Aerosol optical densities), we
wish to use third party libraries such as Pandas, which require the
timestamps to be datetime-like objects.</p>
<p>This notebook illustrates how time is handled in the iris module,
particularly in the
<a class="reference external" href="http://scitools.org.uk/iris/docs/v1.9.0/html/iris/iris/cube.html#iris.cube.Cube">Cube</a>
class, which is the basic data representation object in the <em>Pyaerocom</em>
<code class="docutils literal"><span class="pre">ModelData</span></code> class. In particular, it emphazises some peculiarities
that can lead to complications and finally shows, how <em>Pyaerocom</em>
circumvents these issues. We shall see, that this does not only reduce
the risk of conversion Errors, bu even results in a quite significant
performance boost when converting from numerical CF timestamps to
<code class="docutils literal"><span class="pre">numpy.datetime64</span></code> time stamps.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pyaerocom</span>
</pre></div>
</div>
<div class="section" id="load-and-plot-some-example-data">
<h3>Load and plot some example data<a class="headerlink" href="#load-and-plot-some-example-data" title="Permalink to this headline">¶</a></h3>
<p>Get and load test data file using the new pyaerocom interface (the
underlying datatype of <code class="docutils literal"><span class="pre">ModelData</span></code> is <code class="docutils literal"><span class="pre">iris.cube.Cube</span></code>.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="o">=</span> <span class="n">pyaerocom</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">testfiles</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="n">fpath_ecmwf</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="s1">&#39;ecmwf_osuite&#39;</span><span class="p">]</span>
<span class="n">fpath_aatsr</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="s1">&#39;aatsr_su_v4.3&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">data_ecmwf</span> <span class="o">=</span> <span class="n">pyaerocom</span><span class="o">.</span><span class="n">ModelData</span><span class="p">(</span><span class="n">fpath_ecmwf</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;od550aer&quot;</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;ECMWF_OSUITE&quot;</span><span class="p">)</span>
<span class="n">data_aatsr</span> <span class="o">=</span> <span class="n">pyaerocom</span><span class="o">.</span><span class="n">ModelData</span><span class="p">(</span><span class="n">fpath_aatsr</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;od550aer&quot;</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;AATSR&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Rolling</span> <span class="n">longitudes</span> <span class="n">to</span> <span class="o">-</span><span class="mi">180</span> <span class="o">-&gt;</span> <span class="mi">180</span> <span class="n">definition</span>
</pre></div>
</div>
<p>Note that, if the longitudes are defined on a 0 -&gt; 360 degree grid, they
are automatically converted to -180 -&gt; 180 (the case of the ECMWF data).</p>
<p>Now, let’s have a quick look and see what is in there.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">data_ecmwf</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">()</span>
<span class="n">fig2</span> <span class="o">=</span> <span class="n">data_aatsr</span><span class="o">.</span><span class="n">quickplot_map</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/output_6_0.png" src="_images/output_6_0.png" />
<img alt="_images/output_6_1.png" src="_images/output_6_1.png" />
</div>
<div class="section" id="digging-into-the-time-representation-of-iris-cubes">
<h3>Digging into the time representation of iris Cubes<a class="headerlink" href="#digging-into-the-time-representation-of-iris-cubes" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">ModelData</span></code> class is based on the <code class="docutils literal"><span class="pre">iris.Cube</span></code> object, which can
be accessed via the <code class="docutils literal"><span class="pre">grid</span></code> attribute. In the following, some features
of the <code class="docutils literal"><span class="pre">Cube</span></code> class are introduced.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">cube_ecmwf</span> <span class="o">=</span> <span class="n">data_ecmwf</span><span class="o">.</span><span class="n">grid</span>
<span class="n">cube_aatsr</span> <span class="o">=</span> <span class="n">data_aatsr</span><span class="o">.</span><span class="n">grid</span>
</pre></div>
</div>
<div class="section" id="peculiarities-of-time-handling-when-using-the-cube-interface">
<h4>Peculiarities of time handling when using the <code class="docutils literal"><span class="pre">Cube</span></code> interface<a class="headerlink" href="#peculiarities-of-time-handling-when-using-the-cube-interface" title="Permalink to this headline">¶</a></h4>
<p>Starting with how time is handled. The time is represented as numerical
value relative to a basic date and frequency unit and in the optimum
case, also the specification of a calendar, according to the <a class="reference external" href="http://cfconventions.org/Data/cf-conventions/cf-conventions-1.6/build/cf-conventions.html#time-coordinate">NetCDF CF
conventions</a>.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">times_ecmwf</span> <span class="o">=</span> <span class="n">cube_ecmwf</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ECMWF</span><span class="se">\n</span><span class="s2">First point:</span><span class="si">%s</span><span class="se">\n</span><span class="s2">Time unit: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Calendar: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">times_ecmwf</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                               <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                               <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">))</span>
<span class="n">times_aatsr</span><span class="o">=</span> <span class="n">cube_aatsr</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AATSR</span><span class="se">\n</span><span class="s2">First point:</span><span class="si">%s</span><span class="se">\n</span><span class="s2">Time unit: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Calendar: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">times_aatsr</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                             <span class="n">times_aatsr</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                             <span class="n">times_aatsr</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ECMWF</span>
<span class="n">First</span> <span class="n">point</span><span class="p">:</span><span class="mf">0.0</span>
<span class="n">Time</span> <span class="n">unit</span><span class="p">:</span> <span class="n">day</span> <span class="n">since</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.00000000</span> <span class="n">UTC</span>
<span class="n">Calendar</span><span class="p">:</span> <span class="n">gregorian</span>

<span class="n">AATSR</span>
<span class="n">First</span> <span class="n">point</span><span class="p">:</span><span class="mf">0.0</span>
<span class="n">Time</span> <span class="n">unit</span><span class="p">:</span> <span class="n">day</span> <span class="n">since</span> <span class="mi">2008</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.00000000</span> <span class="n">UTC</span>
<span class="n">Calendar</span><span class="p">:</span> <span class="n">julian</span>
</pre></div>
</div>
<p>Note that the AATSR data is defined using a Julian calendar. The actual
time objects are instances of the <code class="docutils literal"><span class="pre">DimCoord</span></code> class of the iris
package.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">times_ecmwf</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">times_aatsr</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;class &#39;iris.coords.DimCoord&#39;&gt; &lt;class &#39;iris.coords.DimCoord&#39;&gt;
</pre></div>
</div>
<p>Now, if we want to convert these numerically represented time stamps
into datetime-like objects that, for instance, the <code class="docutils literal"><span class="pre">pandas</span></code> library
understands, we have several options. The first one, which is the most
obvious one, is using the provided iris interface which does the
conversion for us, that is, using the <code class="docutils literal"><span class="pre">cell(index)</span></code> method (with the
corresponding <code class="docutils literal"><span class="pre">index</span></code>) of the <code class="docutils literal"><span class="pre">DimCoord</span></code> class in combination with
the <code class="docutils literal"><span class="pre">cells()</span></code> iterator method. However, as we shall see below, this is
not only the slowest solution but it is also prone to errors in case the
calendar is not standard (e.g. Julian).</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">t0_ecmwf</span> <span class="o">=</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
<span class="n">t0_aatsr</span> <span class="o">=</span> <span class="n">times_aatsr</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First time stamp ECMWF </span><span class="si">%s</span><span class="s2"> (data type: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">t0_ecmwf</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">t0_ecmwf</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First time stamp AATSR </span><span class="si">%s</span><span class="s2"> (data type: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">t0_aatsr</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">t0_aatsr</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>First time stamp ECMWF 2018-01-01 00:00:00 (data type: &lt;class &#39;datetime.datetime&#39;&gt;)
First time stamp AATSR 2008-01-01 00:00:00 (data type: &lt;class &#39;netcdftime._netcdftime.DatetimeJulian&#39;&gt;)
</pre></div>
</div>
<p>As you can see, the <code class="docutils literal"><span class="pre">cell</span></code> method returns different datatypes,
dependent on the CF unit convention, that is, a standard Python
<code class="docutils literal"><span class="pre">datetime.datetime</span></code> object, if the calendar is Gregorian, and a
<code class="docutils literal"><span class="pre">netcdftime._netcdftime.DatetimeJulian</span></code> object in case of a Julian
calendar. Problem here is, that the former is understood by pandas,
while the latter is not.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>

<span class="n">t0_ecmwf_pandas</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">t0_ecmwf</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">t0_aatsr_pandas</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">t0_aatsr</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot convert input [2008-01-01 00:00:00] of type &lt;class &#39;netcdftime._netcdftime.DatetimeJulian&#39;&gt; to Timestamp&quot;</span><span class="p">,)</span>
</pre></div>
</div>
<p>Nontheless, numpy is easier in that sense, since it understands both
datatypes.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">t0_ecmwf_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t0_ecmwf</span><span class="p">)</span>
<span class="n">t0_aatsr_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t0_aatsr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t0_ecmwf_np</span><span class="p">,</span> <span class="n">t0_aatsr_np</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.000000</span> <span class="mi">2008</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.000000</span>
</pre></div>
</div>
<p>Fair enough, but however, in the end we want to ensure to have a
conversion method ready that handles any calendar, and that is
considerably fast. We just saw, that <code class="docutils literal"><span class="pre">datetime64</span></code> works for both
datetime formats that we get when calling the <code class="docutils literal"><span class="pre">cell</span></code> method of the
<code class="docutils literal"><span class="pre">DimCoord</span></code> object that holds the time stamps. However, keep in mind,
that whenever <code class="docutils literal"><span class="pre">call</span></code> is called, it performs a conversion of the
numeric value into either <code class="docutils literal"><span class="pre">datetime.datetime</span></code> or, for non-standard
calendars, into a datetime object from the
<a class="reference external" href="https://github.com/Unidata/cftime">cftime</a> package. So, either way,
when using the <code class="docutils literal"><span class="pre">cell</span></code> method we have to iterate over all indices to
convert the numerical values into datetime-like objects. The latter may
be done using the <code class="docutils literal"><span class="pre">cells()</span></code> iterator of the <code class="docutils literal"><span class="pre">DimCoord</span></code> class.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="n">times_ecmwf_conv</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">cells</span><span class="p">()]</span>
<span class="n">times_aatsr_conv</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_aatsr</span><span class="o">.</span><span class="n">cells</span><span class="p">()]</span>
<span class="c1">#display first two</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">times_ecmwf_conv</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span><span class="n">times_aatsr_conv</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>

<span class="p">[</span><span class="n">netcdftime</span><span class="o">.</span><span class="n">_netcdftime</span><span class="o">.</span><span class="n">DatetimeJulian</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">netcdftime</span><span class="o">.</span><span class="n">_netcdftime</span><span class="o">.</span><span class="n">DatetimeJulian</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
<p>This worked, but however, is it fast?</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">cells</span><span class="p">()]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>129 ms ± 13.6 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_aatsr</span><span class="o">.</span><span class="n">cells</span><span class="p">()]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>111 ms ± 8.62 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
<p>The answer is: No, it is not fast, and furthermore, the latter datatype
will not be accepted by pandas as a valid datetime object. We can,
however, convert the datapoints to numpy datetime64 objects during the
conversion (if we want).</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">cells</span><span class="p">()]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>184 ms ± 23.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_aatsr</span><span class="o">.</span><span class="n">cells</span><span class="p">()]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>114 ms ± 7 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
<p>That looks okay, since it does not lead to a notable decrease in the
performance and ensures, that pandas will understand the datatype.
However, about 100ms for conversion of 365 dates is rather slow.</p>
</div>
<div class="section" id="other-options-to-convert-timestamps">
<h4>Other options to convert timestamps<a class="headerlink" href="#other-options-to-convert-timestamps" title="Permalink to this headline">¶</a></h4>
<p>Above we saw how we can convert the numerical timestamps into an array
of numpy <code class="docutils literal"><span class="pre">datetime64</span></code> objects (which is what we want in the end). As
we shall see below, the conversion can be significantly accelarated if
we do not use the iris interface provided by the <code class="docutils literal"><span class="pre">cell(index)</span></code> method
and the <code class="docutils literal"><span class="pre">cells()</span></code> iterator, but rather directly use the underlying
<code class="docutils literal"><span class="pre">cftime</span></code> library (that iris uses).</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">times_ecmwf</span><span class="o">.</span><span class="n">points</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>1.89 ms ± 186 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div>
</div>
<p>This is quite an improvement. But if we dig a little deeper, we can
boost this even more, as we shall see in the following. Basically, what
it does is accessing the base date that is encrypted in the unit, i.e.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">times_ecmwf</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">day</span> <span class="n">since</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.00000000</span> <span class="n">UTC</span>
</pre></div>
</div>
<p>and based on this base date, and the encrypted temporal resolution (here
<em>day</em>) uses the <a class="reference external" href="https://docs.scipy.org/doc/numpy-1.14.0/reference/arrays.datetime.html">pure numpy datetime
functionality</a>
to convert the stuff. For this, we have to test if the first sub string
(here <em>day</em>) is valid according to the CF standard, which we do using
some features from the <code class="docutils literal"><span class="pre">netCDF4</span></code> package and by defining a function,
that translates the numerical timestamps into <code class="docutils literal"><span class="pre">datetime64</span></code> objects
based on the information encoded in the units string(e.g. <em>day since
2018-01-01 00:00:00.00000000 UTC</em>) and the corresponding calendar (e.g.
“gregorian”).</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cf_units</span> <span class="k">import</span> <span class="n">Unit</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">MINYEAR</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">asarray</span><span class="p">,</span> <span class="n">datetime64</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="k">import</span> <span class="p">(</span><span class="n">microsec_units</span><span class="p">,</span> <span class="n">millisec_units</span><span class="p">,</span> <span class="n">sec_units</span><span class="p">,</span> <span class="n">min_units</span><span class="p">,</span>
                    <span class="n">hr_units</span><span class="p">,</span> <span class="n">day_units</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">netCDF4._netCDF4</span> <span class="k">import</span> <span class="n">_dateparse</span>
<span class="c1"># Start of the gregorian calendar</span>
<span class="c1"># adapted from here: https://github.com/Unidata/cftime/blob/master/cftime/_cftime.pyx</span>
<span class="n">GREGORIAN_BASE</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1582</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cftime_to_datetime64</span><span class="p">(</span><span class="n">timesnum</span><span class="p">,</span> <span class="n">cfunit</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert numerical timestamps with epoch to numpy datetime64</span>

<span class="sd">    This method was designed to enhance the performance of datetime conversions</span>
<span class="sd">    and is based on the corresponding information provided in the cftime</span>
<span class="sd">    package (`see here &lt;https://github.com/Unidata/cftime/blob/master/cftime/</span>
<span class="sd">    _cftime.pyx&gt;`__). Particularly, this object does, what the :func:`num2date`</span>
<span class="sd">    therein does, but faster, in case the time stamps are not defined on a non</span>
<span class="sd">    standard calendar.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timesnum : :obj:`list` or :obj:`ndarray`</span>
<span class="sd">        array containing numerical time stamps (relative to basedate of</span>
<span class="sd">        ``cfunit``). Can also be a single number.</span>
<span class="sd">    cfunit : :obj:`str` or :obj:`Unit`</span>
<span class="sd">        CF unit string (e.g. day since 2018-01-01 00:00:00.00000000 UTC) or</span>
<span class="sd">        unit</span>
<span class="sd">    calendar : :obj:`str`, optional</span>
<span class="sd">        string specifying calendar (only required if ``cfunit`` is of type</span>
<span class="sd">        ``str``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        numpy array containing timestamps as datetime64 objects</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if cfunit is ``str`` and calendar is not provided or invalid, or if</span>
<span class="sd">        the cfunit string is invalid</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; cfunit_str = &#39;day since 2018-01-01 00:00:00.00000000 UTC&#39;</span>
<span class="sd">    &gt;&gt;&gt; cftime_to_datetime64(10, cfunit_str, &quot;gregorian&quot;)</span>
<span class="sd">    array([&#39;2018-01-11T00:00:00.000000&#39;], dtype=&#39;datetime64[us]&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">timesnum</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">timesnum</span> <span class="o">=</span> <span class="p">[</span><span class="n">timesnum</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfunit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Require specification of calendar for &quot;</span>
                             <span class="s2">&quot;conversion into datetime64 objects&quot;</span><span class="p">)</span>
        <span class="n">cfunit</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">cfunit</span><span class="p">,</span> <span class="n">calendar</span><span class="p">)</span> <span class="c1">#raises Error if calendar is invalid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfunit</span><span class="p">,</span> <span class="n">Unit</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide cfunit either as instance of class &quot;</span>
                         <span class="s2">&quot;cf_units.Unit or as a string&quot;</span><span class="p">)</span>
    <span class="n">cfu_str</span><span class="p">,</span> <span class="n">calendar</span> <span class="o">=</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">calendar</span>
    <span class="n">basedate</span> <span class="o">=</span> <span class="n">_dateparse</span><span class="p">(</span><span class="n">cfu_str</span><span class="p">)</span>
    <span class="n">cfu_str</span> <span class="o">=</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">name</span>
    <span class="n">basedate</span> <span class="o">=</span> <span class="n">_dateparse</span><span class="p">(</span><span class="n">cfu_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;proleptic_gregorian&#39;</span> <span class="ow">and</span> <span class="n">basedate</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">MINYEAR</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gregorian&#39;</span><span class="p">,</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">basedate</span> <span class="o">&gt;</span> <span class="n">GREGORIAN_BASE</span><span class="p">)):</span>
        <span class="n">cfu_str</span> <span class="o">=</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">name</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cfu_str</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">microsec_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;us&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">millisec_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">sec_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">min_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">hr_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span>
        <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">day_units</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unsupported time units&#39;</span><span class="p">)</span>

        <span class="n">basedate</span> <span class="o">=</span> <span class="n">datetime64</span><span class="p">(</span><span class="n">basedate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basedate</span> <span class="o">+</span> <span class="n">asarray</span><span class="p">(</span><span class="n">timesnum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;timedelta64[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span><span class="n">tstr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asarray</span><span class="p">([</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cfunit</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">timesnum</span><span class="p">)])</span>
</pre></div>
</div>
<p>Now let’s see how this one performs.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="n">cftime_to_datetime64</span><span class="p">(</span><span class="n">times_ecmwf</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>58.5 µs ± 1.25 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<p>Actually, due to this significant increase in performance for standard
calendars (compared to the methods used in netCDF4), the above method
was implemented in the pyaerocom package (<a class="reference external" href="aerocom.met.no/pyaerocom/api.html#pyaerocom.helpers.cftime_to_datetime64">see
here</a>).</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyaerocom.helpers</span> <span class="k">import</span> <span class="n">cftime_to_datetime64</span> <span class="k">as</span> <span class="n">pyaerocom_tconversion</span>
</pre></div>
</div>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="n">pyaerocom_tconversion</span><span class="p">(</span><span class="n">times_ecmwf</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">times_ecmwf</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>63 µs ± 2.82 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<p>For the AATSR data, the method is slower, since here, the slower
<code class="docutils literal"><span class="pre">num2date</span></code> method is used.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="n">pyaerocom_tconversion</span><span class="p">(</span><span class="n">times_aatsr</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">times_aatsr</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>1.76 ms ± 27.3 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
<p>Now this is an improvement. Starting with around 100ms when using the
iris interface (i.e. iterating over <code class="docutils literal"><span class="pre">cells</span></code> of the <code class="docutils literal"><span class="pre">DimCoord</span></code>), for
conversion of 365 time stamps, we ended up with the order of 10
microseconds. And at the same time the new method ensures that we have
them in a format that also pandas understands.</p>
<p>The method is also the standard conversion method in the
<code class="docutils literal"><span class="pre">ModelData.time_stamps()</span></code> method:</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="n">data_ecmwf</span><span class="o">.</span><span class="n">time_stamps</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>90 µs ± 4.76 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">timeit</span>
<span class="n">data_aatsr</span><span class="o">.</span><span class="n">time_stamps</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>1.93 ms ± 129 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="readme.html" class="btn btn-neutral" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, met.no.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
      <script type="text/javascript" src="_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
      <script type="text/javascript" src="_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>